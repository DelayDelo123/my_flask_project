---
- name: –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –ü—Ä–æ—Å—Ç–æ–≥–æ Flask-—Å–∞–π—Ç–∞
  hosts: web_servers # –ì—Ä—É–ø–ø–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –±—É–¥–µ–º —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞—Ç—å
  become: yes # –í—ã–ø–æ–ª–Ω—è—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏ —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (—á–µ—Ä–µ–∑ sudo)

  # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –ª–µ–≥–∫–æ –∏–∑–º–µ–Ω–∏—Ç—å
  vars:
    project_root_path: /opt/my_simple_website # –ö—É–¥–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–∞–π—Ç –Ω–∞ Slave –í–ú
    nginx_listen_port: 80 # –ü–æ—Ä—Ç, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º Nginx –±—É–¥–µ—Ç —Å–ª—É—à–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã (–æ–±—ã—á–Ω–æ 80 –¥–ª—è HTTP)
    flask_app_port: 5000 # –ü–æ—Ä—Ç, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º Flask-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç —Å–ª—É—à–∞—Ç—å
    # –ü—É—Ç—å –∫ –Ω–∞—à–µ–º—É –ø—Ä–æ–µ–∫—Ç—É –Ω–∞ AWX-Master –í–ú.
    # AWX –±—É–¥–µ—Ç –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã –∏–∑ —ç—Ç–æ–π –ø–∞–ø–∫–∏ –Ω–∞ Slave.
    local_source_code_path: "/home/user/my_flask_project"

  tasks:
    - name: "–ë–õ–û–ö 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –°—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –°–µ—Ä–≤–∏—Å–æ–≤"
      block:
        - name: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∑–∞–ø—É—â–µ–Ω –ª–∏ Flask-—Å–∞–π—Ç (–ø–æ–∏—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞)
          ansible.builtin.shell: "pgrep -f 'python {{ project_root_path }}/app.py'"
          register: flask_process_check # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã
          ignore_errors: yes # –ï—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω, —ç—Ç–æ –Ω–µ –æ—à–∏–±–∫–∞ –¥–ª—è –Ω–∞—Å
          changed_when: false # –≠—Ç–∞ –∑–∞–¥–∞—á–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è–µ—Ç –Ω–∞ —Å–∏—Å—Ç–µ–º–µ

        - name: –û—Ç–∫–ª—é—á–∏—Ç—å Flask-—Å–∞–π—Ç, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –∑–∞–ø—É—â–µ–Ω
          ansible.builtin.command: "pkill -f 'python {{ project_root_path }}/app.py'"
          when: flask_process_check.rc == 0 # –í—ã–ø–æ–ª–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∞—è –∫–æ–º–∞–Ω–¥–∞ –Ω–∞—à–ª–∞ –ø—Ä–æ—Ü–µ—Å—Å (–∫–æ–¥ –≤–æ–∑–≤—Ä–∞—Ç–∞ 0)
          ignore_errors: yes # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –ø—Ä–æ—Ü–µ—Å—Å —É–∂–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è

        - name: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ Nginx
          ansible.builtin.package:
            name: nginx
            state: present # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–∞–∫–µ—Ç Nginx —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
          check_mode: yes # –û–ß–ï–ù–¨ –í–ê–ñ–ù–û: –†–µ–∂–∏–º –ø—Ä–æ–≤–µ—Ä–∫–∏, –Ω–∏—á–µ–≥–æ –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç, —Ç–æ–ª—å–∫–æ –≥–æ–≤–æ—Ä–∏—Ç, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏
          register: nginx_installed_check # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
          changed_when: false # –≠—Ç–∞ –∑–∞–¥–∞—á–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è–µ—Ç

        - name: –í—ã–∫–ª—é—á–∏—Ç—å Nginx, –µ—Å–ª–∏ –æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –∞–∫—Ç–∏–≤–µ–Ω
          ansible.builtin.systemd:
            name: nginx # –ò–º—è —Å–ª—É–∂–±—ã Nginx
            state: stopped # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–ª—É–∂–±—É
            enabled: no # –û—Ç–∫–ª—é—á–∏—Ç—å –∏–∑ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∏—Å—Ç–µ–º—ã
          when: nginx_installed_check.changed # –í—ã–ø–æ–ª–Ω—è—Ç—å, –µ—Å–ª–∏ Nginx –±—ã–ª –æ–±–Ω–∞—Ä—É–∂–µ–Ω –∫–∞–∫ "—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π"
          ignore_errors: yes # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –µ—Å–ª–∏ Nginx –Ω–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω

    - name: "–ë–õ–û–ö 2: –ó–∞–≥—Ä—É–∑–∫–∞ –ü—Ä–æ–µ–∫—Ç–∞, –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx"
      block:
        - name: –°–æ–∑–¥–∞—Ç—å –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ Slave –í–ú
          ansible.builtin.file:
            path: "{{ project_root_path }}" # –ü—É—Ç—å, –∫—É–¥–∞ —Å–∫–æ–ø–∏—Ä—É–µ–º —Å–∞–π—Ç
            state: directory # –£–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ —ç—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
            mode: '0755' # –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ (rwxr-xr-x)

        - name: –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ —Å AWX-Master –Ω–∞ Slave –í–ú
          ansible.builtin.copy:
            src: "{{ local_source_code_path }}/" # –ò—Å—Ç–æ—á–Ω–∏–∫: –≤–∞—à–∞ –ø–∞–ø–∫–∞ –Ω–∞ AWX-Master
            dest: "{{ project_root_path }}" # –ö—É–¥–∞ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ Slave
            owner: root # –í–ª–∞–¥–µ–ª–µ—Ü —Ñ–∞–π–ª–æ–≤
            group: root # –ì—Ä—É–ø–ø–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞
            mode: '0644' # –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (rw-r--r--)
            # –ü–∞–ø–∫–∏ –±—É–¥—É—Ç –Ω–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∞ –æ—Ç project_root_path

        - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Python3 –∏ pip3 (–º–µ–Ω–µ–¥–∂–µ—Ä –ø–∞–∫–µ—Ç–æ–≤ Python)
          ansible.builtin.package:
            name:
              - python3
              - python3-pip
            state: present # –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–Ω–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã

        - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python –∏–∑ requirements.txt
          ansible.builtin.pip:
            requirements: "{{ project_root_path }}/requirements.txt" # –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –Ω–∞ Slave
            executable: pip3 # –ò—Å–ø–æ–ª—å–∑—É–µ–º pip3

        - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Nginx
          ansible.builtin.package:
            name: nginx
            state: present # –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ Nginx —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

        - name: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Nginx –∫–∞–∫ –æ–±—Ä–∞—Ç–Ω—ã–π –ø—Ä–æ–∫—Å–∏ –¥–ª—è Flask-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          ansible.builtin.template:
            src: nginx_site.conf.j2 # –ò–º—è —Ñ–∞–π–ª–∞ —à–∞–±–ª–æ–Ω–∞ –Ω–∞ AWX-Master (—Å–º. –Ω–∏–∂–µ)
            dest: /etc/nginx/sites-available/default # –ö—É–¥–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ Slave (–¥–ª—è Ubuntu/Debian)
            owner: root
            group: root
            mode: '0644'
          notify: Restart Nginx # –£–≤–µ–¥–æ–º–∏—Ç—å handler –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ Nginx

        - name: –£–¥–∞–ª–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ Nginx (–¥–ª—è Ubuntu/Debian)
          ansible.builtin.file:
            path: /etc/nginx/sites-enabled/default
            state: absent # –£–¥–∞–ª–∏—Ç—å, –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          notify: Restart Nginx # –ß—Ç–æ–±—ã Nginx –ø–æ–¥—Ö–≤–∞—Ç–∏–ª –∏–∑–º–µ–Ω–µ–Ω–∏—è

        - name: –°–æ–∑–¥–∞—Ç—å —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –Ω–∞—à –∫–æ–Ω—Ñ–∏–≥ Nginx (–≤–∫–ª—é—á–∏—Ç—å –µ–≥–æ)
          ansible.builtin.file:
            src: /etc/nginx/sites-available/default
            dest: /etc/nginx/sites-enabled/default
            state: link # –°–æ–∑–¥–∞—Ç—å —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫—É—é —Å—Å—ã–ª–∫—É
            force: yes # –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å, –µ—Å–ª–∏ —Å—Å—ã–ª–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          notify: Restart Nginx # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Nginx –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

    - name: "–ë–õ–û–ö 3: –°—Ç–∞—Ä—Ç –ü—Ä–æ–µ–∫—Ç–∞, Nginx –∏ –§–∏–Ω–∞–ª—å–Ω–∞—è –ü—Ä–æ–≤–µ—Ä–∫–∞"
      block:
        - name: –°–æ–∑–¥–∞—Ç—å systemd —Å–µ—Ä–≤–∏—Å-—Ñ–∞–π–ª –¥–ª—è Flask-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          ansible.builtin.template:
            src: flask_app.service.j2 # –ò–º—è —Ñ–∞–π–ª–∞ —à–∞–±–ª–æ–Ω–∞ –Ω–∞ AWX-Master (—Å–º. –Ω–∏–∂–µ)
            dest: /etc/systemd/system/flask_app.service # –ö—É–¥–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ Slave
            owner: root
            group: root
            mode: '0644'
          notify: Reload systemd and Start Flask App # –£–≤–µ–¥–æ–º–∏—Ç—å handler

        - name: –ó–∞–ø—É—Å—Ç–∏—Ç—å Nginx
          ansible.builtin.systemd:
            name: nginx
            state: started # –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–ª—É–∂–±—É
            enabled: yes # –í–∫–ª—é—á–∏—Ç—å –≤ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∏—Å—Ç–µ–º—ã

        - name: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å–∞–π—Ç –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ Nginx
          ansible.builtin.uri:
            url: "http://localhost:{{ nginx_listen_port }}" # URL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (Nginx —Å–ª—É—à–∞–µ—Ç –Ω–∞ —ç—Ç–æ–º –ø–æ—Ä—Ç—É)
            status_code: 200 # –û–∂–∏–¥–∞–µ–º—ã–π HTTP-—Å—Ç–∞—Ç—É—Å (200 OK)
            validate_certs: no # –ù–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ HTTPS, –∏–∑–º–µ–Ω–∏—Ç–µ)
          register: website_check # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          retries: 10 # –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É 10 —Ä–∞–∑
          delay: 5 # –° –∑–∞–¥–µ—Ä–∂–∫–æ–π –≤ 5 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ (–¥–∞–µ–º –≤—Ä–µ–º—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è)
          until: website_check.status == 200 # –ü—Ä–æ–¥–æ–ª–∂–∞—Ç—å, –ø–æ–∫–∞ —Å—Ç–∞—Ç—É—Å –Ω–µ —Å—Ç–∞–Ω–µ—Ç 200

        - name: –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
          ansible.builtin.debug:
            msg: "ü•≥ –°–∞–π—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É http://{{ ansible_host }}:{{ nginx_listen_port }}/"
          when: website_check.status == 200

  handlers: # –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—é (notify)
    - name: Restart Nginx
      ansible.builtin.systemd:
        name: nginx
        state: restarted

    - name: Reload systemd and Start Flask App
      ansible.builtin.systemd:
        daemon_reload: yes # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é systemd
      - ansible.builtin.systemd:
          name: flask_app # –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–∞—à–µ–π —Å–ª—É–∂–±—ã
          state: started # –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–ª—É–∂–±—É
          enabled: yes # –í–∫–ª—é—á–∏—Ç—å –≤ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫
